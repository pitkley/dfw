name: Prepare release

on:
  push:
    tags:
    - '[0-9]+.[0-9]+.[0-9]+'
    - '[0-9]+.[0-9]+.[0-9]+-*'

jobs:
  build-binaries:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
        - target: x86_64-unknown-linux-musl
          runner: ubuntu-24.04
        - target: aarch64-unknown-linux-musl
          runner: ubuntu-24.04-arm
        - target: armv7-unknown-linux-musleabihf
          runner: ubuntu-24.04-arm

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Retrieve cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ runner.arch }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}-${{ matrix.target }}

    - name: Install Rust toolchain
      run: |
        rustup toolchain install stable --profile minimal --no-self-update
        rustup default stable
        rustup target add ${{ matrix.target }}

    - name: Build release binary
      run: cargo build --release --target ${{ matrix.target }}

    - name: Create checksum
      run: |
        cd target/${{ matrix.target }}/release
        sha256sum dfw > dfw.sha256

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: binary-${{ matrix.target }}
        path: |
          target/${{ matrix.target }}/release/dfw
          target/${{ matrix.target }}/release/dfw.sha256
        if-no-files-found: error
        retention-days: 1

  create-release:
    runs-on: ubuntu-24.04
    needs: build-binaries
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download all binary artifacts
      uses: actions/download-artifact@v4
      with:
        path: binaries
        pattern: binary-*
        merge-multiple: false

    - name: Identify if tag is a prerelease
      id: tag
      run: |
        if [[ "${{ github.ref }}" =~ ^refs/tags/(.+)$ ]]; then
          echo "value=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
        else
          echo "::error ::Expected a tag"
          exit 1
        fi

        if [[ "${{ github.ref }}" =~ ^refs/tags/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "is-prerelease=false" >> $GITHUB_OUTPUT
        else
          echo "is-prerelease=true" >> $GITHUB_OUTPUT
        fi

    - name: Extract current changelog
      id: changelog
      run: |
        changelog="$(hack/extract-current-changelog.py CHANGELOG.md)"
        # https://github.community/t/set-output-truncates-multiline-strings/16852/3
        changelog="${changelog//'%'/'%25'}"
        changelog="${changelog//$'\n'/'%0A'}"
        changelog="${changelog//$'\r'/'%0D'}"
        echo "value=$changelog" >> $GITHUB_OUTPUT

    - name: Prepare release binaries
      run: |
        mkdir -p release-assets
        for target_dir in binaries/binary-*; do
          target=$(basename "$target_dir" | sed 's/binary-//')
          cp "$target_dir/dfw" "release-assets/dfw-$target"
          cp "$target_dir/dfw.sha256" "release-assets/dfw-$target.sha256"
        done
        ls -lah release-assets/

    - name: Create GitHub release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        prerelease: ${{ steps.tag.outputs.is-prerelease }}
        files: release-assets/*
        body: |
          # Summary

          TODO!

          ## Changes

          ${{ steps.changelog.outputs.value }}

          ## Installation

          ### Docker Image (recommended)

          ```console
          $ docker pull ghcr.io/pitkley/dfw:${{ steps.tag.outputs.value }}
          $ docker run -d \
                --name=dfw \
                --restart=unless-stopped \
                -v /var/run/docker.sock:/var/run/docker.sock:ro \
                -v /path/to/your/config:/config \
                --net host --cap-add=NET_ADMIN \
                ghcr.io/pitkley/dfw:${{ steps.tag.outputs.value }} --config-path /config
          ```

          This will download a lightweight image and subsequently run it using your configuration.
          The image supports multiple architectures: `amd64`, `arm64`, `armv7` (specifically `armhf`).

          ### Pre-built binaries

          Pre-built static binaries are available below for the following platforms:

          * `dfw-x86_64-unknown-linux-musl` - Linux x86_64 (amd64)
          * `dfw-aarch64-unknown-linux-musl` - Linux ARM64 (aarch64)
          * `dfw-armv7-unknown-linux-musleabihf` - Linux ARMv7 (armhf, for 32-bit Raspberry Pi OS)
